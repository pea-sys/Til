# Looks Good To Me みんなのコードレビュー

## Pt.1 コードレビューの基本

### Ch.1 コードレビューの重要性

- コードレビューとは、ソフトウェア開発者が、互いにコードを検査し、合意された一連の基準を満たしていることを確認するために使用するプロセスである。検査は、あなたの肩越しであったり、正式な会議または PR を通じて行える。

- コードレビューは、ソフトウェア開発において、例外ではなく当たり前であるべきである。なぜか？コードレビューによって、（明確で読み易く、メンテナンスしやすいコードを通じて）優れたアプリが作成され、（知識の移転・共有、記録保持のメカニズムを通して）チーム全体のコードベースと、互いに対する理解を深めることが出来るからである

- 優れたコードレビューは結束力のあるチーム、つまり、全てのメンバーが尊重され、価値が認められ、チームの平等な一員として扱われていると感じられるチームを基盤として構築される

### Ch.2 コードレビュー徹底解剖

- コードレビューシステムには、リアルタイムの会議や議論、対面でのレビューを通じて、コードの変更を評価する人間主導型、ソフトウェアやオンラインプラットフォームによるツール支援型、そして、それらを組み合わせたハイブリット型がある

- 一般的なコードレビューのワークフローは、新規もしくは変更されたコード、１人以上のレビュー担当者（理想的にはコードの作者以外）、レビューの仕組み、承認条件という４つの要素で構成される

- 優れた PR には、明確で簡潔なタイトルと、詳細コンテキストが詰まった説明を含み、ラベルを使用して PR に情報を追加し、レビューの各フェーズに応じたレビュー状態を使用する

* レビュー担当者には大きな権限が与えられており、承認したコードに対する責任を負う。優れたレビュー担当者になるには、与えられた影響力を乱用せず、毎回徹底的にレビューし、エゴを捨て、レビューする際は、PR 作成者ではなく、コードに焦点を当てる

* PR 作成者は可能な限り、PR を管理しやすく、分かりやすくする責務がある。PR を合計５００行以下の簡単にレビューできるパーツに分割して、３０分以内で詳細にレビューできるようにし、PR を理解するために必要なコンテキストと情報を可能な限り多く含める必要がある。また、エゴを捨て、フィードバックを個人的に受け止めず、フィードバックを元にコードを改善するサイクルを受け入れる必要がある

* チームがコードレビュープロセスのテンポを決める。信頼・結束・経験・コミュニケーションのパターンが高まるほど、コードレビュープロセスは緩やかになる。

* テックリードやエンジニアリングマネージャーなどの責任者は、チームにとっての最適なプロセスを支援し、奨励する義務がある。リソース、影響力、実施、熱意を通じて、プロフェッショナルなコードレビュー環境を確立し、維持し、推進するために、最善を尽くさなければならない

* 4 つの DORA 指標は、チームの状態に関するデータを収集し、分析し始めるための優れた基本指標である。これらを使用してチームの現状を分類し、適宜改善に取り組むこと

### Ch.3 チームの最初のコードレビュープロセスの構築

- 最初のコードレビュープロセスを構築する際には、目標の設定、ツールとワークフローの選定、ガイドラインの設定、そして櫃世に応じたプロセスの改良の４つのフェーズがある
- まず、チームのコードレビューの目標を設定する。コードレビューを確立する際に選べる目標には、バグの発見、コードベースの安定性とメンテナンス性、知識移転・共有、メンタリング、記録の保持・作成が含まれる。全てが必須というわけではない。重要なのは、どの目標がチームに適しているかを判断することである

- 次に、コードレビューを用意にするためのツール／プラットフォームを選定する。どのコードレビュー機能が必要で、どの機能がプロセスにほしいのかを理解することで、ツールを比較する際に役立てられる

* 最後に、コードレビューに関するガイドラインを設定する。最初は、ワークフローを確立し、レビューの焦点を定め、承認を止めるべき問題と止めるべきではない問題を区別し、承認ポリシーの明確化に重点を置くこと。これらはよい出発点だが、チームがコードレビュープロセスに慣れてきたら、チームでこれらを拡張できるし、していくべきである

* プロセスの改良は推奨されており、これもコードレビュープロセスを成させる要因の１つである。これは、チームメンバーが提案された変更について話し合い、結果を決定し、その新しい変更をチーム全体に普及することで実施される

## Pt.2 高度なコードレビューに必須の要素

### Ch.4 チームワーキングアグリーメント

- TWA は、暗黙の社会的期待を明示的で強制できるものに変える。TWA には、チームによって策定され、実施されるポリシーと基準が含まれる

- TWA は、自動化できないポリシーやガイドラインに活用されるべきである。自動化を基盤とするのであれば、ツールやスクリプト、ソフトウェアなどを通じて、チームは、繰り返し実行でき、客観的かつ拡張性のあるプロセスを確保できる。自動で設定できないその他の全てのことに関しては TWA が役に立つ。

- プロセスに関する明確な期待がないと、チーム内に不信感や敵対心を生む可能性がある、プロセスをドキュメント化するだけではなく、コードレビューにおけるチーム、つまり PR 作成者とレビュー担当者どちらに対する暗黙の期待も、TWA にドキュメント化すること。

* TWA は、チームが互いにどのように関わりあいたいのか、どのようなチームの空気を作り出そうとしているのかを明記するべきである。適切な応答時間、ニットピックへの対応、レビュー担当者の焦点など、暗黙の期待を含めること

* TWA が有用であるかどうかは、チーム次第である。TWA を全てのメンバーが閲覧可能な場所に維持し、アクセス可能にしておくことが重要である。また、チームのニーズに合わせて継続的に改良することが、TWA を重要であり続けさせるためのカギとなる。

* TWA は、チーム全体の責任である。したがって、メンバー全員が TWA の共同作成者、実施者、そしてメンテナンス担当者であるべきである。チームメンバーが離脱したり、新たに加わったりする際には、TWA へのアクセスもそれに応じて変更しなければならない

* TWA は生きたドキュメントであり、最初のバージョンが完成してもそこで終わりではない。これはよいことである。TWA の改良、更新、変更が奨励されている

* TWA を変更しやすい状態にしておくことが重要である。変更のプロセスが煩雑であればあるほど、チームは、無視したり、軽視したりしやすくなる。TWA を維持する最良の方法は、バージョン管理し、コードレビュープロセスと統合することだ。
* TWA は他の作業と同様に扱うこと。文書をチーム全体で所有し、ドキュメント化されたポリシーに対して互いに責任をもつことで、TWA は効果的でかけがえのないもになる

### Ch.5 自動化のメリット

- 自動化は退屈で煩わしい作業を得意としている。このカテゴリに該当するコードレビューの作業は、可能な限り自動化すべきである

- 自動化によって、コードレビュー中に、徹底的で効果的な作業をするための時間と集中力を確保できる

* 自動化しやすい候補は、リンティング、フォーマット、静的解析、そしてテストである。これらのツールは全て、開発を行う際に使用するべきである。これによって、コードレビュー自体から最も退屈で重要度の低い問題を排除できる

* PR テンプレートは、PR 作成者が PR を適切に準備するのに役立つ。その作成を自動化し、バグ修正、ドキュメント更新、新機能、標準のテンプレートなど、PR の種類ごとに異なるテンプレートを使用すること

* PR バリデータは、PR の品質と一貫性を強化するのに役立つ。タイトルのフォーマット、ラベル管理、PR サイズ、そしてチーム全体のコードレビューの実施状況の追跡を自動で行う

* 偏りをなくし、適切な担当者にコードレビューを割り当てるために、レビュー担当者の割り当てを自動化すること！Guthub には、変更され t 合ファイルに基づいて特定の個人またはチームを PR に割り当てるために、リポジトリごとに使用できる CODEOWNER ファイルがある

* PR ゲートチェックによって、レビュー担当者は、ノイズの多い作業と精神的負担から解放される。PR ゲートチェックをプロセスに追加すると、レビュー痰鳥栖ははコードレビューで本当に重要なことに集中できる。また、より正確で高速かつ徹底したボットに多くの品質チェックを任せられるため、チームはマージするコードに対する自信も高まる

* リマインダーとエスカレーションは機械に任せるべきである。新しくオープンされた PR やレビューされていない PR、PR 作成者が 24 時間以内に対応していない PR コメントなど、重要な PR イベントに対して自動メールやリマインダーを設定すること

### Ch.6 効果的なコードレビューコメントの作成

- 私たちはコードベースのメンテナンスのしやすさを目指して、コードレビューのコメントを書く。この目標に貢献しないのであれば、それは書く必要のないコメントである可能性が高い

- 効果的なコメントは、効果的なコミュニケーションに依存する。また、客観的で具体的で明確な結果を持っている

- 客観的なコメントは、コードに焦点を当て、客観的なリソースを根拠とし、それを容易に山椒できる。5P プロセス（立ち止まって(Pause)熟考し(Ponder)見送る(Pass)か提案する(Propose)か延期する(Postpone)）を用いて、客観的な提案を行える。また、MMG 交換は明確ではない話題についての妥協点をを見つけるのに役立つ

* 具体的なコメントは、何かをする必要があるのかを示し、問題となるコードを明確に指摘する。何かをする必要があるかどうかを明確にするために、コメントシグナル、MosCoW コメント、Conventional Comments を試してみること。変換／メソッド／クラス名を書きだし、正確な行番号を列挙し、正確な山椒にリンクすること。明確であればあるほど、ＰＲ作成者にとってわかりやすくなる

* 結果重視のコメントは、PR 作成者がとるべき行動を正確に伝える。それらは、通常、コードの状態を変える変換動詞を含む。そして、実施した結果は容易に測定できる

* トリプル R パターン(依頼、根拠、結果)は、変更や修正を依頼するコメントを書くのに役立つ。依頼を具体的にし、その背景にある根拠を示し、比較するための明確な結果を持つことで、ＰＲ作成者が理解して受け入れやすくなる

* 本当に斬新でユニークな良いものを見つけたら、それを伝えること。コードレビューではコードへの称賛は常に歓迎される

* 敬意はトーン、つまり、コメントの書き方や選ぶ言葉に現れる

* 常に礼儀正しく親切であること

## Pt.3 ジレンマへの対処

### Ch.7 コードレビューがだめになる理由

- コードレビューは時間と主に難しい問題を引き起こす可能性がある

- コードレビューが怠慢になったり、意地悪になったり、管理不能になったり、過度に複雑化したりするのを積極的に防ぐこと。このような方向に進むと、コードレビュープロセスは、良好な状態から非常に悪い状態へ変質してしまう可能性がある

### Ch.8 レビューの遅延を減らす

- 良いコードレビューは時間がかかるが、かかりすぎることはない。コードレビュープロセスにおける不要な遅延を排除することで、コードレビューに対する恐怖を軽減できる

* ほとんどの遅延は明確さの欠如や当然の責務を果たしていないことに起因する

* シニア開発者が 1 人しかいないからといって、全てのコードレビューをそのシニア開発者に割り当てる必要はない。シニア開発者の専門知識を必要としない変更については、チーム全体で均等にレビューを振り分け、最終的にはチーム全員の知識レベルを向上させるべきである
* あなたは詳しくないが、チームの責任範囲内 PR が割り当てられた場合、そのコードについて、もっと学ぶ機会を作ること。

* PR 作成者は、レビュー担当者が成功できるように PR を準備する責務がある。自分の PR をレビューし、コードの変更を理解するために必要な全てのコンテキストと情報が利用可能であることを確認すること

* コードの変更が小さければ、PR も小さくなる。PR をオープンする前に、コードの変更やファイルを小さな部分に分割すること。早い段階で少し計画を立てるだけで PR が小さくなるか大きくなるかが変わる。

* 設計／計画フェーズにギャップがないかを確認すること。受け入れ基準を明確にし、UI コンポーネントをビジネスロジックから分離するか、フィーチャーフラグを使用して、大きな機能を分割すること。機能が小さければ小さいほど、結果として生じる PR も小さくなる

* 議論が何度も繰り返される場合は、オフラインで話し合い、理解を深めること。話し合いの結果は PR に記録すること。

* 原因に応じて機能を分割したり、正式なコードレビューの前により迅速で頻繁なレビューを実施したり、経験豊富な開発者とペアを組んだりすることで、コードの変更を軌道に載せ、チームの標準を維持するのに役立つ。また、PR を何度もやり直さなくて済むようになる。

* 当然の責務を果たすことは、私たちの仕事の一部である。私たちがこの考え方を受け入れ、シフトしていけばいくほど、レビュープロセスは全ての開発者にとってよりものになるはずだ

### Ch.9 プロセスの抜け穴を取り除く

- どんな優れたコードレビュープロセスにも抜け穴は存在し、時間の経過とともに発生する可能性がある。それらに対して常に警戒を怠らないこと

- 明確に定義されたコードレビュープロセスがないと、一貫性のないレビューになったり、レビューを完全に省略する人が現れたりするかもしれない。チームワーキングアグリーメントでプロセスを明確に定義すること

- プロセスを定義する必要がある場合は、基準のワークフローを作成してチームで合意し、一定期間にわたって問題点や改善が必要な領域を観察し、発見された弱点を基準のワークフローに反映させ、そのあと、時間をかけてそれぞれの弱点に対する解決策を見つけていくこと

- コードレビューの時間が不足しているのは、管理不能な大きさの PR に起因することがある。PR を小さくすること。小さな PR をレビューできないという言い訳は通用しない

- フィードバック文化が欠如しているチームでは、多くのことが非常にやりにくくなり、コードレビューは特に大きな影響を受ける。まずは、テックリードやエンジニアリングマネージャーであれば、チームにどのようなトーンを設定したいのかを正直に見つめなおす必要がある。自分自身がチームに求める行動を実践できていない場合、まずはそこから改善すること

* チーム内でフィードバックを奨励し、強化すること。チームがさまざまなフィードバックの仕組みにな慣れ、その価値を理解し、日常業務の一部として実施するほど、フィードバック文化を育みやすくなる

* 指標に影響されてコードレビューの手を抜かないこと。代わりに、チームのコードレビューの有効性のシグナルとして、指標とコンテキストに合わせた議論を組み合わせること、検討すべき指標には、コードの変更頻度、レビュー時間、レビュー参加度、PR のサイズなどがある

* 緊急度のプロセスは意図的には煩雑にすること。こうすることで、確率されたコードレビュープロセスを回避するために、個人がこれを悪用するのを防げる

## Ch.10 緊急時対応プレイバック

- 緊急時対応プレイブックとは、緊急事態発生時に実行する正式なプロセス、行動判断をまとめたものである

- 緊急時対応プレイバックは、共同で作成し、正しく使用されｒことで、非常に有用なツールとなる。独自のプレイブックの作成を開始する際、特に実際のプロセスを構築する場合には、セキュリティチームとコンプライアンスチームを議論に参加させること

- 緊急時対応プレイブックに含まれる各緊急事態対応プロセスには、意思決定ツリー、承認プロセス、回避策、実施すべきアクション／タスク、そして、文書化、伝達、インシデントの事後分析などの完了後の詳細な次のステップが含まれるべきである

- 緊急時対応プレイブックは、収益損失を引き起こす本番環境の障害に対するホットフィックスなど、本当に緊急事態の場合のみに使用されるべきである

## Pt.4 コードレビューとその他の開発プラクティスを組み合わせる

### Ch.11 コードレビューとペアプログラミング

- ペアプログラミングは、２人のプログラマーが１台のワークステーションまたは共有のオンライン共同開発環境で、一緒に作業するソフトウェア開発の手法である
- ペアプログラミングとコードレビューの両方を検討すべきである。これらは、互いを置き換えるものではなく、補完し合うものである

- ペアプログラミングとコードレビューは、それぞれ異なる目標を達成する。ペアプログラミングは最も効果的な解決策を導き出す。コードレビューは、コードベースで何が起きているのかをチーム全体に伝える

- ペアプログラミングは、問題の早期発見、新しいチームメンバーのコードレビューへの速やかな参加、コードレビューのフィードバックへの迅速な対応、開発初期からの適切な設計判断など、いくつかの点でコードレビューを強化する

* ペアプログラミングは、様々な理由でコードレビューに置き換わることはない。最も重要な理由は何か？履歴の記録が作成されないことである。公式の記録がなければ、コードの変更の背景にある根拠は、ペアを組んだ開発者だけに残る。その他の理由は、チームの残りのメンバーへの知識移転の制限、偏りのない視点の欠如、コードレビューの範囲が限られるなどである
* ドライバー・ナビゲータースタイルが最も一般的なペアプログラミングのスタイルだが、ほかにも、自動車学校、ポモドーロ、ツアーガイド、ピンポン、ダッグチームといったスタイルも検討に値する

* 効果的なペアプログラミングは、開発者間で容易に役割の交代が出来る専用のワークステーション、ペアセッションの短縮、特定のタスクに限定したペアプログラミング、スキルレベルの一致と性格の相性など、いくつかの要素に依存する。これらにより、最も効果的なペアセッションが促進される

* ペアプログラミングはリモートチームにいくつかの課題を突き付ける。パートナーと同じ場所において、１台のワークステーションを共有することで得られる手軽さと利便性が失われる。

* より効果的なリモートペアプログラミングを実現するには、可能な限り対面に近い状態を再現すること。ビデオをオンにし、静かな場所を見つけ、ノイズキャンセリングヘッドフォンを使用し、ペアプログラミングを促進するツールを選ぶ。

### Ch.12 コードレビューとモブプログラミング

- モブプログラミングは、２人以上のメンバーが協力して問題を解決する手法である。開発者である必要はなく、特定の専門知識で問題解決をサポートできる人であれば、だれでも参加できる

- モブプログラミングとコードレビューは、両方行うべきである。それぞれ異なる目標を達成するため、互いに置き換えられない
- モブプログラミングは、知識共有に特にに優れている。従来のコードレビューよりも、深く広範な学習機会を参加者に提供できる

- コードレビューは、ワークフローの中で唯一の記録保持機能を果たす。モブプログラミングのみを行うと、モブセッション中に生成されたコードの変更の背景にあるコンテキストと決定事項が失われてしまう

- モブプログラミングは、コードレビューを補完するため、どちらも行う価値がある。モブプログラミングは、リアルタイムのフィードバックとレビューループを提供し、チーム全体が信じられないほどの速さで互いに知識を共有できるようにする。その結果、レビュー担当者がレビュー対象のコードに精通し、コードレビューをより短時間で、より的確に、より効果的に行える

* モブプログラミングをワークフローに組み込むアプローチには次のようなものがある

  - 合意してから分割：モブプログラミングは個別の作業に移る前に、主要な設計決定や高レベルの事項について合意を得るために使用される

  - 未知への挑戦：モブプログラミングは、チーム全体が不慣れな問題に取り組む際に使用される

  - 記録と記述：モブプログラミングをデフォルトの作業方法とし、モブセッション中に生成された変更の背景にあるコンテキストを記録するために、より軽量なコードレビューが使用される

  - モブコードレビュー：チームがコードを生成するのではなく、協力してコードをレビューする

* モブプログラミングには、特有の課題がある。グループの人数過多・集中力の欠如・集団志向・コミュニケーションスキル不足によるモブセッションの効果の低下、リモートモブプログラミングがもたらす障壁などに注意すること

### Ch.13 コードレビューと AI

- AI は素晴らしいアシスタントになりえる。レビューをスピードアップし、一貫性のあるレビュー担当者として機能し、大規模なチームのレビューをより効率化し、レビューを通過するコードの品質をさらに向上させることができる

- AI はコンテキストやニュアンスを理解することの難しさや、学習データへの依存といった限界があり、コードレビュープロセスを完全に引き継ぐまでには至っていない、最終的な判断を下し、AI の作業を検証するのは、依然として人間である

- コードレビューにおいて、AI に過度に依存しないことが重要である。そうしないと批判的思考能力やコードを理解する能力が低下する可能性がある

- AI には何ができるのか？PR のサマリ、コードの提案、インラインコードリファクタリング、PR のフィードバックチャット、PR の分析などを通じて、多くの時間を節約できる。

- チームにとって意味があり、慎重に計画を立てて導入するのであれば、AI をコードレビューに組み込むことは推奨される。

※ツールメモ

- AICodeReview
- CodeRabbit
- Copilot for Pull Requests
- What The Diff
- Qodo
- Metabob
